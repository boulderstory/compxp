<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMP XP | Boulder Story</title>
    <style>
        /* [Keep the same CSS from the previous version here] */
        /* I have added a loading overlay style below */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: #f72585; display: none; justify-content: center; align-items: center; z-index: 1000; font-family: monospace; }
        * { box-sizing: border-box; }
        body { padding: 0; margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f6f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .hidden { display: none !important; }
        #login-page { background: linear-gradient(180deg, #1a0b2e 0%, #4b1d52 40%, #f72585 80%, #ff9e00 100%); min-height: 100vh; color: white; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .retro-sun { width: 100px; height: 100px; background: linear-gradient(180deg, #ffca3a, #ff595e); border-radius: 50%; box-shadow: 0 0 30px #ffca3a; margin-bottom: 20px; }
        .neon-text { font-family: 'Courier New', monospace; font-size: 2.2em; font-weight: 900; color: #fff; text-shadow: 0 0 15px #f72585; }
        .retro-box { background: rgba(0,0,0,0.7); padding: 25px; border-radius: 15px; width: 100%; max-width: 350px; border: 1px solid #f72585; }
        .retro-box input { width: 100%; margin-bottom: 15px; padding: 12px; border-radius: 5px; border: none; font-size: 16px; text-align: center; }
        .retro-btn { background: #f72585; color: white; width: 100%; padding: 15px; border: none; font-weight: bold; border-radius: 5px; cursor: pointer; text-transform: uppercase; }
        .xp-badge { background: #111; color: #fff; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        #dispBal { color: #ffd700; font-size: 2.5em; font-weight: 900; display: block; }
        .tab-bar { display: flex; gap: 5px; position: sticky; top: 0; background: #f4f6f9; padding: 10px 0; z-index: 100; border-bottom: 2px solid #ddd; }
        .tab-bar button { flex: 1; font-size: 10px; background: #e0e0e0; border: none; font-weight: bold; padding: 12px 5px; border-radius: 5px; cursor: pointer; }
        .tab-bar button.active { background: #2c3e50; color: #fff; }
        .week-header { background: #e67e22; color: white; padding: 10px; margin: 20px 0 10px 0; border-radius: 5px; font-weight: 900; text-align: center; }
        .route-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 12px; border-radius: 8px; background: #fff; color: #111; }
        .btn-group { display: flex; gap: 4px; margin-top: 10px; }
        .btn-group button { flex: 1; padding: 10px; border: none; font-weight: bold; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .flash { background: #ffd700; color: #000; } .top { background: #2ecc71; color: #fff; } .zone { background: #3498db; color: #fff; } .reset { background: #fce4e4; color: #c0392b; }
        .info-section { background: #fff; color: #111; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        .reward-btn { width: 100%; text-align: left; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; background: #fff; border: 1px solid #ccc; padding: 15px; border-radius: 8px; cursor: pointer; color: #111; }
    </style>
</head>
<body>

<div id="loader">ACCESSING MAINFRAME...</div>

<div id="login-page">
    <div class="retro-sun"></div>
    <div class="neon-text">COMP XP</div>
    <div class="retro-box">
        <input type="email" id="log-email" placeholder="EMAIL">
        <input type="password" id="log-pin" class="hidden" placeholder="PIN" maxlength="4">
        <div id="reg-fields" class="hidden">
            <input type="text" id="reg-name" placeholder="FULL NAME">
            <input type="password" id="reg-pin" placeholder="CREATE PIN" maxlength="4">
            <label style="color:white; font-size: 12px;"><input type="checkbox" id="reg-opt" checked> Leaderboard Opt-in</label>
        </div>
        <button id="main-btn" class="retro-btn" onclick="handleAuth()">ENTER</button>
    </div>
</div>

<div id="app-page" class="hidden container">
    <div class="tab-bar">
        <button id="btn-score" class="active" onclick="showTab('score')">SCORECARD</button>
        <button id="btn-leader" onclick="showTab('leader'); loadLeaderboard();">RANKING</button>
        <button id="btn-prizes" onclick="showTab('prizes')">REWARDS</button>
        <button id="btn-info" onclick="showTab('info')">INFO</button>
    </div>
    <div class="xp-badge">
        <h2 id="dispName">---</h2>
        <strong id="dispBal">0</strong>
        <span style="font-size:12px; color:#aaa">TOTAL XP: <span id="dispTotal">0</span></span>
    </div>
    <div id="tab-score">
        <div class="week-header">WEEK 1</div><div id="w1-list"></div>
        <div class="week-header">WEEK 2</div><div id="w2-list"></div>
    </div>
    <div id="tab-leader" class="hidden"><div class="info-section"><h3>Top 10</h3><div id="leader-list"></div></div></div>
    <div id="tab-prizes" class="hidden">
        <div class="info-section"><h3>History</h3><div id="claims-list"></div></div>
        <div class="info-section"><h3>Shop</h3><div id="shop-list"></div></div>
        <div class="info-section">
            <input type="password" id="staffPass" placeholder="Staff Pass">
            <button onclick="verifyIG(1)" style="width:100%; padding:10px; margin-top:5px;">Verify IG W1</button>
            <button onclick="verifyIG(2)" style="width:100%; padding:10px; margin-top:5px;">Verify IG W2</button>
        </div>
    </div>
    <div id="tab-info" class="hidden"><div class="info-section"><h3>Timeline</h3><p>W1: March 2-8<br>W2: March 9-15</p></div></div>
</div>

<script>
    // PASTE YOUR GOOGLE WEB APP URL HERE
    const API_URL = "https://script.google.com/macros/s/AKfycbwHd8V6dhA0Y4E1Q8P9kn-39Ac9wqEspkelJ3DL87AAB8Ps7KPcIVp4gR8n1gQjYLXcSQ/exec";
    let user = null;

    async function callAPI(params) {
        document.getElementById('loader').style.display = 'flex';
        const query = new URLSearchParams(params).toString();
        const response = await fetch(`${API_URL}?${query}`);
        const data = await response.json();
        document.getElementById('loader').style.display = 'none';
        return data;
    }

    async function handleAuth() {
        const email = document.getElementById('log-email').value;
        const pin = document.getElementById('log-pin').value;
        
        if(document.getElementById('reg-fields').classList.contains('hidden')) {
            const res = await callAPI({ action: 'login', email, pin });
            if(res.isNew) {
                document.getElementById('reg-fields').classList.remove('hidden');
                document.getElementById('main-btn').innerText = "REGISTER";
            } else if(res.needsPin) {
                document.getElementById('log-pin').classList.remove('hidden');
            } else if(res.error) {
                alert(res.error);
            } else {
                user = res; renderApp();
            }
        } else {
            const name = document.getElementById('reg-name').value;
            const newPin = document.getElementById('reg-pin').value;
            const optIn = document.getElementById('reg-opt').checked;
            user = await callAPI({ action: 'register', email, name, pin: newPin, optIn });
            renderApp();
        }
    }

    function renderApp() {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app-page').classList.remove('hidden');
        document.getElementById('dispName').innerText = user.name;
        document.getElementById('dispBal').innerText = user.balance;
        document.getElementById('dispTotal').innerText = user.lifetime;

        const now = new Date();
        const w1Lock = (now < new Date('2026-03-02T00:00:00') || now > new Date('2026-03-08T22:00:00'));
        const w2Lock = (now < new Date('2026-03-09T00:00:00') || now > new Date('2026-03-15T22:00:00'));

        let w1H = ""; let w2H = "";
        for(let i=0; i<16; i++) {
            let locked = (i < 8) ? w1Lock : w2Lock;
            let h = `<div class="route-item">
                <strong>Route ${i<8?(i+1):(i-7)}</strong> <span style="float:right">${user.scores[i]||0} XP</span>
                <div class="btn-group">
                    <button class="flash" ${locked?'disabled':''} onclick="setScore(${i},100)">Flash</button>
                    <button class="top" ${locked?'disabled':''} onclick="setScore(${i},80)">Top</button>
                    <button class="zone" ${locked?'disabled':''} onclick="setScore(${i},30)">Zone</button>
                    <button class="reset" ${locked?'disabled':''} onclick="setScore(${i},0)">X</button>
                </div>
            </div>`;
            if(i<8) w1H += h; else w2H += h;
        }
        document.getElementById('w1-list').innerHTML = w1H;
        document.getElementById('w2-list').innerHTML = w2H;
        document.getElementById('claims-list').innerHTML = user.claims.map(c => `<div>âœ“ ${c}</div>`).join('') || "None";
        const rewards = [["Sticker", 15], ["Raffle", 20], ["10% Voucher", 100], ["Keychain", 160], ["T-shirt", 790], ["5 Day Pass", 1400]];
        document.getElementById('shop-list').innerHTML = rewards.map(r => `<button class="reward-btn" onclick="redeem('${r[0]}',${r[1]})"><span>${r[0]}</span> <strong>${r[1]} XP</strong></button>`).join('');
    }

    async function setScore(idx, val) {
        const res = await callAPI({ action: 'saveScore', email: user.email, idx, val });
        if(res.error) alert(res.error);
        else refresh();
    }

    async function loadLeaderboard() {
        const list = await callAPI({ action: 'leaderboard' });
        document.getElementById('leader-list').innerHTML = list.map((l, i) => `<div>#${i+1} ${l.name} - ${l.score} XP</div>`).join('');
    }

    async function refresh() { user = await callAPI({ action: 'login', email: user.email, pin: "bypass" }); renderApp(); }
    
    function showTab(t) {
        ['score', 'leader', 'prizes', 'info'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
    }

    async function verifyIG(w) {
        const pass = document.getElementById('staffPass').value;
        await callAPI({ action: 'verifyIg', email: user.email, week: w, pass });
        refresh();
    }

    async function redeem(item, cost) {
        const pass = prompt("Staff Pass:");
        await callAPI({ action: 'redeem', email: user.email, item, cost, pass });
        refresh();
    }
</script>
</body>
</html>
